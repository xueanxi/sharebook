# 小说转漫画视频工作流架构设计

## 项目概述

本项目旨在将爬取的50章小说内容转换为若干个90秒左右的漫画视频。每张漫画图片根据旁白的节奏会停留3~6秒。工作流使用LangChain v1.0.0框架实现，主要包括信息提取、内容创作和输出准备三个主要阶段。

## 工作流架构

### 整体流程图

```
小说文本 → 信息提取 → 内容创作 → 输出准备 → 漫画视频素材
```

### 阶段一：信息提取

#### 1. 文本预处理Agent
- **功能**：加载和清洗小说文本
- **输入**：50章小说文本文件
- **处理过程**：
  - 加载所有章节文本
  - 进行文本清洗和分段
  - 识别章节边界和关键情节
  - 标准化文本格式
- **输出**：结构化的文本数据

#### 2. 人物提取Agent
- **功能**：识别和提取小说中的人物信息
- **处理过程**：
  - 使用命名实体识别(NER)提取人物名称
  - 分析人物关系和互动
  - 识别主要角色和配角
  - 跟踪人物在章节中的出现频率
- **输出**：人物列表及基本信息

#### 3. 剧情分析Agent
- **功能**：分析小说的情节结构
- **处理过程**：
  - 提取每章的主要情节线
  - 识别关键转折点和高潮
  - 构建50章的整体剧情时间线
  - 分析情节发展趋势
- **输出**：剧情结构化数据

#### 4. 爽点识别Agent
- **功能**：识别小说中的"爽点"情节
- **处理过程**：
  - 识别"打脸"、"逆袭"、"获得宝物"等爽点情节
  - 分析爽点强度和类型
  - 为爽点打分和分类
  - 定位爽点在章节中的具体位置
- **输出**：爽点列表及评分

### 阶段二：内容创作

#### 1. 人物卡片生成Agent (基于LangGraph工作流)
- **功能**：为小说中所有角色创建多阶段视觉档案
- **工作流设计**：
  ```
  分组Agent → 并行角色卡片提取Agent → 角色信息合并Agent → 角色卡片更新Agent
  ```
- **处理过程**：
  - **分组Agent**：根据已有角色重要性（主角/配角/龙套）进行分组处理
  - **并行角色卡片提取Agent**：每组处理2-3个角色，提取当前章节视觉信息
  - **角色信息合并Agent**：检查角色是否已有卡片，判断是否需要新增阶段
  - **角色卡片更新Agent**：合并新信息到现有角色卡片，确保时间线连贯性
- **阶段划分策略**：
  - 主要角色：多阶段分析（早期/中期/晚期）
  - 重要配角：单阶段描述，核心特征提取
  - 龙套角色：最简描述，1-2个视觉标签
- **重大变化判断标准**：
  - 实力突破：突破、晋级、飞升等
  - 外貌变化：变身、恢复、重伤等
  - 装备获得：获得法宝、装备等
- **输出**：多阶段角色卡片（包含时间轴视觉特征）

#### 2. 分镜规划Agent
- **功能**：将小说内容规划为视频分镜
- **处理过程**：
  - 将50章内容划分为若干90秒视频片段
  - 为每个片段设计15-30个镜头(每镜头3-6秒)
  - 确保分镜节奏符合叙事需求
  - 平衡各视频片段的内容分布
- **输出**：分镜规划方案

#### 3. 场景设计Agent
- **功能**：设计每个分镜的场景
- **处理过程**：
  - 识别每个分镜的关键场景
  - 生成场景描述和氛围设定
  - 确保场景连贯性
  - 设计场景转换方式
- **输出**：场景设计方案

### 阶段三：输出准备

#### 1. 提示词生成Agent
- **功能**：为图像生成创建详细提示词
- **处理过程**：
  - 为每个分镜生成详细的图像生成提示词
  - 包含人物、场景、动作、风格等元素
  - 优化提示词以适应AI图像生成
  - 确保提示词的一致性和多样性
- **输出**：图像生成提示词列表

#### 2. 旁白脚本生成Agent
- **功能**：为每个分镜编写旁白
- **处理过程**：
  - 为每个分镜编写3-6秒的旁白
  - 确保旁白与画面同步
  - 控制旁白长度和节奏
  - 优化旁白的表达效果
- **输出**：旁白脚本

## Agent协作架构

### 主控Agent
- 协调各个子Agent的工作流程
- 决策任务优先级和执行顺序
- 处理异常和错误恢复
- 管理工作流状态和进度

### 专业工具集
- **文本处理工具**：分段、清洗、实体识别
- **分析工具**：情感分析、情节分析
- **创作工具**：提示词生成、脚本编写
- **存储工具**：结果缓存、状态管理

### 记忆系统
- **短期记忆**：当前处理状态
- **长期记忆**：人物档案、剧情发展
- **实体记忆**：人物关系、世界观设定

## 技术实现要点

### 模型选择
- 使用GPT-4或类似大语言模型作为核心推理引擎
- 针对不同任务使用不同的提示模板
- 考虑使用专门的模型进行特定任务（如NER）

### 并行处理
- 对不同章节可以并行处理
- 人物提取和剧情分析可以并行进行
- 分镜规划和场景设计可以并行进行

### 质量控制
- 设置检查点验证中间结果
- 使用评分机制评估输出质量
- 实现人工干预接口
- 建立反馈循环优化输出

## 输出格式

### 人物卡片格式
```json
{
  "name": "叶君临",
  "importance": "main",
  "visual_timeline": {
    "early": {
      "chapters": "1-15",
      "core_features": ["银白发", "老者面容"],
      "clothing": ["破旧灰袍"],
      "key_items": ["拐杖"],
      "quote": "原文引用...",
      "key_changes": "穿越→元婴突破"
    },
    "middle": {
      "chapters": "16-35",
      "core_features": ["银发及腰", "青年面容"],
      "clothing": ["黑色长袍"],
      "key_items": ["葬天棺"],
      "quote": "原文引用...",
      "key_changes": "实力巩固，收徒"
    },
    "late": {
      "chapters": "36-50",
      "core_features": ["强者风范"],
      "clothing": ["可能新增装备/法宝"],
      "key_items": ["新增法宝"],
      "quote": "原文引用...",
      "key_changes": "战斗力提升"
    }
  },
  "base_features": ["银白长发", "黑袍"],
  "changes": ["老者→青年", "虚弱→强大"],
  "relationships": {
    "allies": ["虚有年"],
    "enemies": ["青鹏妖王"],
    "neutral": []
  }
}
```

### 分镜脚本格式
```json
{
  "segment_id": 1,
  "title": "遇强则强",
  "duration": 90,
  "source_chapters": [1, 2],
  "scenes": [
    {
      "scene_id": 1,
      "duration": 4,
      "visual_prompt": "白发老者拄拐杖站在湖边，湖面倒映苍老面容，玄幻风格，高清细节",
      "narration": "叶君临做梦都没想到，他只是上课偷偷睡觉，醒来后居然发现自己穿越了。",
      "characters": ["叶君临"],
      "scene_type": "intro",
      "mood": "confused"
    },
    {
      "scene_id": 2,
      "duration": 5,
      "visual_prompt": "老人愤怒地挥舞拐杖，天空乌云密布，远处有妖气逼近，紧张氛围",
      "narration": "看着湖面上那张布满皱纹的老脸，叶君临气得浑身都在发抖，红着眼睛悲愤地喊道。",
      "characters": ["叶君临"],
      "scene_type": "conflict",
      "mood": "angry"
    }
  ],
  "key_moments": [
    {
      "timestamp": 45,
      "description": "叶君临获得元婴期修为",
      "highlight_type": "power_up"
    }
  ]
}
```

## 实施计划

### 第一阶段：基础框架搭建
1. 设置LangChain环境
2. 创建基础Agent结构
3. 实现文本加载和预处理功能
4. 测试基本的Agent通信

### 第二阶段：核心功能开发
1. 实现人物提取和剧情分析功能
2. 开发爽点识别算法
3. 创建人物卡片生成功能
4. 测试信息提取的准确性

### 第三阶段：内容创作功能
1. 实现分镜规划算法
2. 开发场景设计功能
3. 创建提示词生成系统
4. 编写旁白脚本生成器

### 第四阶段：优化和测试
1. 优化各Agent之间的协作
2. 提高输出质量和一致性
3. 进行端到端测试
4. 收集反馈并改进

## 技术栈

- **核心框架**：LangChain v1.0.0
- **语言模型**：参考：config\llm_config.py
- **数据处理**：pandas, numpy
- **文本处理**：spaCy,智能体（LangChain）
- **存储**：JSON, SQLite
- **可视化**：matplotlib, plotly (用于进度和结果展示)

## 扩展考虑

### 多模态支持
- 考虑添加音频生成功能
- 支持多种图像风格
- 实现动态场景转换

### 用户交互
- 开发简单的Web界面
- 提供参数调整选项
- 实现结果预览和编辑功能

### 性能优化
- 实现增量处理
- 添加缓存机制
- 优化API调用频率

---

*此文档将作为项目开发的基础指南，后续可根据实际需求进行调整和扩展。*