# 故事板到提示词转换功能设计文档

## 1. 功能概述

本功能旨在将已有的故事板JSON文件转换为适用于图像生成的场景提示词，以便于AI图像生成工具能够根据故事板内容创建相应的漫画场景图像。

## 2. 输入数据结构

### 2.1 故事板JSON文件结构

故事板JSON文件位于`data/storyboards/`目录下，文件命名格式为`第X章 [章节标题]_storyboards.json`。

每个JSON文件包含以下主要部分：

```json
{
  "chapter_info": {
    "chapter_number": "第一章",
    "chapter_title": "遇强则强",
    "total_segments": 5
  },
  "basic_stats": {
    "total_scenes": 15,
    "total_characters": 3
  },
  "segments": [
    {
      "segment_id": 1,
      "text_content": "故事文本内容...",
      "metadata": {
        "word_count": 150,
        "scene_count": 3
      },
      "scenes": [
        {
          "scene_id": 1,
          "scene_description": "场景描述",
          "environment": "环境描述",
          "atmosphere": "氛围描述",
          "time": "时间描述",
          "characters": [
            {
              "name": "角色名",
              "appearance": "外观描述",
              "expression": "表情描述",
              "action": "动作描述",
              "emotion": "情绪描述"
            }
          ],
          "visual_narrative": {
            "camera_angle": "镜头角度",
            "composition": "构图描述",
            "lighting": "光线描述",
            "color_scheme": "色彩方案",
            "special_effects": "特效描述"
          }
        }
      ]
    }
  ]
}
```

## 3. 输出数据结构

### 3.1 提示词JSON文件结构

转换后的提示词将保存为JSON文件，位于`data/prompts/`目录下，文件命名格式为`第X章 [章节标题]_prompts.json`。

```json
{
  "chapter_info": {
    "chapter_number": "第一章",
    "chapter_title": "遇强则强",
    "total_segments": 5,
    "total_prompts": 15
  },
  "prompts": [
    {
      "prompt_id": "1-1",
      "segment_id": 1,
      "scene_id": 1,
      "text_content": "原始故事文本内容...",
      "prompt_text": "生成的提示词文本...",
      "negative_prompt": "负面提示词文本...",
      "metadata": {
        "style": "漫画风格",
        "quality_tags": ["高质量", "细节丰富"],
        "aspect_ratio": "16:9"
      }
    }
  ]
}
```

## 4. 功能架构

### 4.1 核心组件

1. **StoryboardToPromptProcessor**
   - 主处理类，负责协调整个转换流程
   - 提供批量处理和单文件处理接口

2. **ChapterSorter**
   - 复用现有的章节排序工具
   - 负责按章节顺序处理故事板文件

3. **PromptGenerator**
   - 负责根据场景信息生成提示词
   - 实现多种提示词生成策略

4. **FileManager**
   - 负责文件读写操作
   - 处理目录创建和文件路径管理

### 4.2 数据流程

```
故事板JSON文件 → 章节排序 → 场景提取 → 提示词生成 → 结果保存
```

## 5. 提示词生成策略

### 5.1 基础提示词模板

```
漫画风格，{环境}，{氛围}，{时间}，{角色描述}，{动作}，{表情}，{情绪}，
{镜头角度}视角，{构图}，{光线}，{色彩方案}，{特效}，高质量，细节丰富
```

### 5.2 提示词优化规则

1. **角色描述组合**：将角色的外观、表情、动作和情绪组合成连贯的描述
2. **环境与氛围融合**：将环境描述与氛围描述自然融合
3. **视觉元素优先**：优先使用视觉叙事元素增强提示词效果
4. **风格标签添加**：自动添加"漫画风格"、"高质量"等风格标签
5. **负面提示词生成**：生成避免低质量、变形等问题的负面提示词

### 5.3 特殊处理规则

1. **多角色场景**：按重要性排序描述多个角色
2. **动作场景**：强调动态感和力量感
3. **情感场景**：突出情绪表达和氛围营造
4. **环境场景**：强调环境细节和空间感

## 6. 实现细节

### 6.1 目录结构

```
src/
├── services/
│   └── storyboard_to_prompt/
│       ├── __init__.py
│       ├── config.yaml
│       ├── storyboard_to_prompt_processor.py
│       ├── prompt_generator.py
│       └── file_manager.py
└── utils/
    └── text_processing/
        └── chapter_sorter.py (现有)
```

### 6.2 关键方法

1. **StoryboardToPromptProcessor.process_all_chapters()**
   - 处理所有章节的故事板文件
   - 返回处理结果统计

2. **StoryboardToPromptProcessor.process_chapter(file_path)**
   - 处理单个章节的故事板文件
   - 生成对应的提示词文件

3. **PromptGenerator.generate_prompt(scene)**
   - 根据场景信息生成提示词
   - 应用各种优化规则

4. **FileManager.save_prompts(chapter_info, prompts, output_path)**
   - 保存生成的提示词到JSON文件
   - 确保目录存在

### 6.3 配置参数

#### 6.3.1 config.yaml 配置文件

```yaml
# 故事板到提示词转换配置
storyboard_to_prompt:
  # 输入输出路径配置
  paths:
    # 故事板JSON文件所在目录
    storyboard_dir: "data/storyboards"
    # 提示词JSON文件输出目录
    output_dir: "data/prompts"
  
  # 提示词生成配置
  prompt_generation:
    # 风格标签
    style_tags: ["漫画风格", "高质量", "细节丰富"]
    # 负面提示词
    negative_prompts: ["低质量", "模糊", "变形", "多余肢体"]
    # 默认宽高比
    default_aspect_ratio: "16:9"
    # 提示词最大长度
    max_prompt_length: 500
  
  # 处理配置
  processing:
    # 是否启用多线程处理
    enable_multithreading: false
    # 线程数量（仅当enable_multithreading为true时有效）
    thread_count: 4
    # 是否覆盖已存在的输出文件
    overwrite_existing: false
  
  # 日志配置
  logging:
    # 日志级别 (DEBUG, INFO, WARNING, ERROR)
    level: "INFO"
    # 是否启用文件日志
    enable_file_logging: true
    # 日志文件路径
    log_file_path: "logs/storyboard_to_prompt.log"
```

#### 6.3.2 配置参数说明

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| storyboard_dir | 故事板JSON文件所在目录 | "data/storyboards" |
| output_dir | 提示词JSON文件输出目录 | "data/prompts" |
| style_tags | 提示词风格标签 | ["漫画风格", "高质量", "细节丰富"] |
| negative_prompts | 负面提示词 | ["低质量", "模糊", "变形", "多余肢体"] |
| default_aspect_ratio | 默认宽高比 | "16:9" |
| max_prompt_length | 提示词最大长度 | 500 |
| enable_multithreading | 是否启用多线程处理 | false |
| thread_count | 线程数量 | 4 |
| overwrite_existing | 是否覆盖已存在的输出文件 | false |
| level | 日志级别 | "INFO" |
| enable_file_logging | 是否启用文件日志 | true |
| log_file_path | 日志文件路径 | "logs/storyboard_to_prompt.log" |

## 7. 使用示例

### 7.1 批量处理所有章节

```python
from src.services.storyboard_to_prompt.storyboard_to_prompt_processor import StoryboardToPromptProcessor

# 使用默认配置
processor = StoryboardToPromptProcessor()
result = processor.process_all_chapters()
print(f"处理完成，共处理 {result['total_chapters']} 章，生成 {result['total_prompts']} 个提示词")

# 使用自定义配置文件
processor = StoryboardToPromptProcessor(config_path="custom_config.yaml")
result = processor.process_all_chapters()
```

### 7.2 处理单个章节

```python
processor = StoryboardToPromptProcessor()
result = processor.process_chapter("data/storyboards/第一章 遇强则强_storyboards.json")
print(f"处理完成，生成 {result['prompt_count']} 个提示词")
```

## 8. 扩展性设计

### 8.1 提示词策略扩展

- 通过添加新的提示词生成策略类，支持不同的图像生成工具
- 支持自定义提示词模板和优化规则

### 8.2 输出格式扩展

- 支持多种输出格式（JSON、TXT、CSV等）
- 支持直接集成到图像生成工具

### 8.3 质量评估扩展

- 添加提示词质量评估功能
- 支持人工评估和自动优化

## 9. 注意事项

1. **文件路径处理**：确保在不同操作系统下路径处理正确
2. **编码处理**：确保中文内容正确处理
3. **异常处理**：对文件读写和数据处理进行充分的异常处理
4. **性能考虑**：对于大量文件的处理，考虑添加进度显示和性能优化
5. **日志记录**：添加详细的日志记录，便于问题排查

## 10. 测试计划

1. **单元测试**：测试各个组件的核心功能
2. **集成测试**：测试完整的转换流程
3. **边界测试**：测试异常数据和边界情况
4. **性能测试**：测试大量文件处理的性能
5. **输出质量测试**：评估生成提示词的质量和适用性

## 11. 版本计划

- **v1.0**：实现基础的故事板到提示词转换功能
- **v1.1**：添加多种提示词生成策略
- **v1.2**：添加提示词质量评估和优化功能
- **v2.0**：支持多种输出格式和集成方式