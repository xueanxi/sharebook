# 角色图片生成功能设计文档

## 1. 功能概述

本功能旨在根据角色数据中的提示词，使用ComfyUI生成角色图片，并将生成的图片保存到指定目录。系统将从`characters.csv`文件中读取角色信息，提取最后一列的容貌提示词，然后使用ComfyUI生成对应的角色图片。

## 2. 需求分析

### 2.1 功能需求
- 从`data/characters/characters.csv`文件中读取角色数据
- 提取角色姓名和容貌提示词（最后一列）
- 为每个角色创建专属的图片目录
- 使用ComfyUI生成角色图片
- 将生成的图片保存到对应角色的目录中

### 2.2 非功能需求
- 确保图片生成的质量和一致性
- 提供错误处理和日志记录
- 支持批量处理和单个角色处理
- 提供进度反馈

## 3. 系统设计

### 3.1 架构设计

```
角色图片生成系统
├── 角色数据读取模块
├── 图片生成控制模块
├── ComfyUI接口模块
└── 文件管理模块
```

### 3.2 模块设计

#### 3.2.1 角色数据读取模块 (CharacterDataReader)
- **功能**: 负责从CSV文件中读取角色数据
- **输入**: CSV文件路径
- **输出**: 角色数据列表，包含姓名和提示词
- **主要方法**:
  - `read_characters(file_path)`: 读取角色数据
  - `validate_data(data)`: 验证数据完整性

#### 3.2.2 图片生成控制模块 (CharacterImageGenerator)
- **功能**: 控制整个图片生成流程
- **主要方法**:
  - `generate_all_characters()`: 生成所有角色图片
  - `generate_single_character(name)`: 生成指定角色图片
  - `batch_generate(names)`: 批量生成指定角色图片

#### 3.2.3 ComfyUI接口模块 (ComfyUIInterface)
- **功能**: 封装ComfyUI API调用
- **依赖**: `ComfyUIWrapper`类
- **主要方法**:
  - `setup_workflow()`: 设置工作流
  - `generate_image(prompt, save_path)`: 生成单张图片
  - `update_prompt(prompt)`: 更新提示词

#### 3.2.4 文件管理模块 (FileManager)
- **功能**: 管理图片文件的存储
- **主要方法**:
  - `create_character_directory(name)`: 为角色创建目录
  - `save_image(image_data, path)`: 保存图片
  - `get_image_path(name, filename)`: 获取图片路径

## 4. 数据流设计

```
CSV文件 -> 角色数据读取 -> 提取姓名和提示词 -> 创建角色目录 -> 
设置ComfyUI工作流 -> 更新提示词 -> 生成图片 -> 保存图片 -> 记录日志
```

## 5. 接口设计

### 5.1 命令行接口

```bash
# 生成所有角色图片
python -m src.services.character_image_generator --all

# 生成指定角色图片
python -m src.services.character_image_generator --name "角色名"

# 批量生成多个角色图片
python -m src.services.character_image_generator --names "角色1,角色2,角色3"

# 指定输出目录
python -m src.services.character_image_generator --output "自定义输出路径"
```

### 5.2 编程接口

```python
from src.services.character_image_generator import CharacterImageGenerator

# 创建生成器实例
generator = CharacterImageGenerator()

# 生成所有角色图片
results = generator.generate_all_characters()

# 生成指定角色图片
result = generator.generate_single_character("搬山宗宗主")

# 批量生成
results = generator.batch_generate(["搬山宗宗主", "叶师弟", "灵儿"])
```

## 6. 文件结构

```
src/services/character_image_generation/
├── __init__.py
├── character_image_generator.py     # 主要功能实现
├── character_data_reader.py          # 角色数据读取
├── comfyui_interface.py              # ComfyUI接口封装
└── file_manager.py                   # 文件管理功能

data/characters/image/                # 图片输出目录
├── 搬山宗宗主/
│   ├── image_001.png
│   └── image_002.png
├── 叶师弟/
│   ├── image_001.png
│   └── image_002.png
└── ...
```

## 7. 实现细节

### 7.1 角色数据读取实现

```python
import csv
from typing import List, Dict, Tuple

class CharacterDataReader:
    def __init__(self, csv_file_path: str):
        self.csv_file_path = csv_file_path
    
    def read_characters(self) -> List[Dict[str, str]]:
        """读取角色数据"""
        characters = []
        with open(self.csv_file_path, 'r', encoding='utf-8') as file:
            reader = csv.DictReader(file)
            for row in reader:
                # 提取姓名和容貌提示词
                name = row['姓名'].strip()
                prompt = row['容貌提示词'].strip('"')
                if name and prompt:
                    characters.append({
                        'name': name,
                        'prompt': prompt,
                        'gender': row['性别'],
                        'type': row['角色类型']
                    })
        return characters
```

### 7.2 图片生成控制实现

```python
import os
from typing import List, Dict, Optional
from .character_data_reader import CharacterDataReader
from .comfyui_interface import ComfyUIInterface
from .file_manager import FileManager

class CharacterImageGenerator:
    def __init__(self, 
                 csv_file_path: str = "data/characters/characters.csv",
                 output_base_dir: str = "data/characters/image",
                 workflow_template: str = "comfyui/novel_t2I_flux.json"):
        self.data_reader = CharacterDataReader(csv_file_path)
        self.comfyui_interface = ComfyUIInterface(workflow_template)
        self.file_manager = FileManager(output_base_dir)
        self.characters = self.data_reader.read_characters()
    
    def generate_all_characters(self) -> Dict[str, List[str]]:
        """生成所有角色图片"""
        results = {}
        for character in self.characters:
            try:
                image_paths = self.generate_single_character(character['name'])
                results[character['name']] = image_paths
                print(f"成功生成角色 {character['name']} 的图片")
            except Exception as e:
                print(f"生成角色 {character['name']} 图片时出错: {str(e)}")
                results[character['name']] = []
        return results
    
    def generate_single_character(self, name: str) -> List[str]:
        """生成指定角色图片"""
        # 查找角色
        character = next((c for c in self.characters if c['name'] == name), None)
        if not character:
            raise ValueError(f"未找到角色: {name}")
        
        # 创建角色目录
        character_dir = self.file_manager.create_character_directory(name)
        
        # 生成图片
        return self.comfyui_interface.generate_image(
            prompt=character['prompt'],
            save_dir=character_dir
        )
```

### 7.3 ComfyUI接口实现

```python
import os
from typing import List, Dict
from src.utils.comfyui_wrapper import ComfyUIWrapper

class ComfyUIInterface:
    def __init__(self, workflow_template: str):
        self.workflow_template = workflow_template
        self.wrapper = None
    
    def setup_workflow(self) -> Dict:
        """设置工作流"""
        if not self.wrapper:
            self.wrapper = ComfyUIWrapper()
            self.wrapper.connect()
        
        return self.wrapper.load_workflow_template(self.workflow_template)
    
    def generate_image(self, prompt: str, save_dir: str) -> List[str]:
        """生成图片"""
        workflow = self.setup_workflow()
        
        # 更新提示词
        self.wrapper.update_workflow_text(workflow, "1", prompt)
        
        # 设置批处理大小
        self.wrapper.update_workflow_batch_size(workflow, "9", 1)
        
        # 生成图片
        with self.wrapper:
            output_images = self.wrapper.generate_images(workflow, save_dir)
        
        return list(output_images.values())
    
    def __del__(self):
        """析构函数，确保连接关闭"""
        if self.wrapper:
            self.wrapper.disconnect()
```

### 7.4 文件管理实现

```python
import os
from typing import List

class FileManager:
    def __init__(self, base_dir: str):
        self.base_dir = base_dir
        # 确保基础目录存在
        os.makedirs(self.base_dir, exist_ok=True)
    
    def create_character_directory(self, character_name: str) -> str:
        """为角色创建目录"""
        # 清理角色名称，移除不适合作为目录名的字符
        safe_name = "".join(c for c in character_name if c.isalnum() or c in (' ', '-', '_')).rstrip()
        character_dir = os.path.join(self.base_dir, safe_name)
        os.makedirs(character_dir, exist_ok=True)
        return character_dir
    
    def get_image_path(self, character_name: str, filename: str) -> str:
        """获取图片路径"""
        safe_name = "".join(c for c in character_name if c.isalnum() or c in (' ', '-', '_')).rstrip()
        return os.path.join(self.base_dir, safe_name, filename)
```

## 8. 错误处理与日志

### 8.1 错误处理策略
- 文件读取错误：提供明确的错误信息，检查文件是否存在和格式是否正确
- ComfyUI连接错误：自动重试机制，提供连接状态检查
- 图片生成错误：记录详细错误信息，支持跳过错误角色继续处理
- 文件保存错误：检查目录权限，提供备用保存路径

### 8.2 日志记录
- 使用项目的日志系统记录关键操作和错误
- 记录每个角色的处理状态和结果
- 记录图片生成的时间、参数等信息

## 9. 性能考虑

- 批量处理时使用连接池，避免频繁建立和断开ComfyUI连接
- 支持并行处理多个角色图片生成
- 提供进度反馈，便于长时间运行的批量操作
- 支持断点续传，记录已处理的角色，避免重复生成

## 10. 扩展性设计

- 支持多种图片生成模型和工作流
- 支持自定义图片尺寸和风格参数
- 支持角色提示词的后处理和增强
- 支持图片质量评估和自动筛选
- 支持角色图片的版本管理

## 11. 测试计划

### 11.1 单元测试
- 测试角色数据读取功能
- 测试文件管理功能
- 测试ComfyUI接口封装

### 11.2 集成测试
- 测试完整的图片生成流程
- 测试批量处理功能
- 测试错误处理机制

### 11.3 性能测试
- 测试大量角色图片生成的性能
- 测试并发处理能力
- 测试资源使用情况

## 12. 部署与使用

### 12.1 部署要求
- 确保ComfyUI服务器正常运行
- 确保有足够的磁盘空间存储生成的图片
- 确保网络连接稳定

### 12.2 使用示例

```python
# 示例1: 生成所有角色图片
from src.services.character_image_generation import CharacterImageGenerator

generator = CharacterImageGenerator()
results = generator.generate_all_characters()

# 示例2: 生成指定角色图片
result = generator.generate_single_character("搬山宗宗主")
print(f"生成的图片路径: {result}")

# 示例3: 使用命令行工具
# python -m src.services.character_image_generation --name "搬山宗宗主"
```

## 13. 后续优化方向

1. **智能提示词优化**: 基于角色特征自动优化提示词
2. **图片质量评估**: 实现自动图片质量评估和筛选
3. **批量处理优化**: 实现更高效的批量处理机制
4. **用户界面**: 开发图形界面，提供更友好的操作体验
5. **角色一致性**: 确保同一角色的多张图片保持一致性
6. **自定义风格**: 支持用户自定义图片风格和参数

## 14. 总结

本设计文档详细描述了角色图片生成功能的实现方案，包括系统架构、模块设计、接口定义、实现细节等方面。该功能将有效地利用现有的角色数据和ComfyUI工具，为每个角色生成高质量的图片，并按照角色姓名进行分类存储。通过合理的错误处理和日志记录机制，确保系统的稳定性和可维护性。